<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>法语词汇分类与记忆系统</title>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #6d98ba;
            --accent-color: #ff9a3c;
            --light-bg: #f5f7fa;
            --dark-bg: #2c3e50;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --text-dark: #333;
            --text-light: #f8f9fa;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--light-bg);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 20px 0;
            text-align: center;
            margin-bottom: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1, h2, h3 {
            margin-bottom: 15px;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: var(--primary-color);
            color: var(--text-light);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            text-decoration: none;
        }

        .btn:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
        }

        .btn-accent {
            background-color: var(--accent-color);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-warning {
            background-color: var(--warning);
            color: var(--text-dark);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .flex {
            display: flex;
            flex-wrap: wrap;
        }

        .space-between {
            justify-content: space-between;
        }

        .align-center {
            align-items: center;
        }

        .col-1-2 {
            flex: 0 0 calc(50% - 15px);
        }

        .col-1-3 {
            flex: 0 0 calc(33.333% - 20px);
        }

        .col-2-3 {
            flex: 0 0 calc(66.666% - 20px);
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        /* Form Controls */
        .form-group {
            margin-bottom: 15px;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        /* Sidebar */
        .sidebar {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            height: fit-content;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .category-list {
            list-style: none;
        }

        .category-item {
            margin-bottom: 10px;
            cursor: pointer;
            padding: 8px;
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .category-item:hover {
            background-color: var(--light-bg);
        }

        .category-item.active {
            background-color: var(--primary-color);
            color: var(--text-light);
        }

        .sub-category {
            margin-left: 20px;
            display: none;
        }

        .show {
            display: block;
        }

        /* Word Cards */
        .word-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .word-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 20px;
            position: relative;
            transition: var(--transition);
        }

        .word-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .word-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 24px;
        }

        .phonetic {
            color: var(--secondary-color);
            font-style: italic;
            margin-bottom: 15px;
        }

        .translation {
            margin-bottom: 15px;
            font-weight: 600;
        }

        .example {
            padding: 10px;
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            font-style: italic;
        }

        .category-tag {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--text-dark);
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 20px;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-learning {
            background-color: var(--warning);
            color: var(--text-dark);
        }

        .status-mastered {
            background-color: var(--success);
            color: var(--text-light);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: var(--border-radius);
            max-width: 600px;
            width: 90%;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
        }

        /* Tabs */
        .tabs {
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            display: inline-block;
            padding: 10px 20px;
            cursor: pointer;
            margin-right: 10px;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
        
        /* 子选项卡内容 */
        .sub-tab-content {
            display: none;
        }
        
        .sub-tab-content.active {
            display: block;
        }

        /* Search Bar */
        .search-bar {
            margin-bottom: 30px;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            box-shadow: var(--box-shadow);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        /* Quiz */
        .quiz-container {
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .quiz-options {
            list-style: none;
            margin-top: 15px;
        }

        .quiz-option {
            padding: 10px 15px;
            background-color: var(--light-bg);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            cursor: pointer;
            transition: var(--transition);
        }

        .quiz-option:hover {
            background-color: var(--secondary-color);
            color: var(--text-light);
        }

        .quiz-option.correct {
            background-color: var(--success);
            color: var(--text-light);
        }

        .quiz-option.incorrect {
            background-color: var(--danger);
            color: var(--text-light);
        }

        .quiz-progress {
            margin-top: 20px;
            height: 10px;
            background-color: var(--light-bg);
            border-radius: 5px;
            overflow: hidden;
        }

        .quiz-progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .col-1-2, .col-1-3, .col-2-3 {
                flex: 0 0 100%;
            }
            
            .sidebar {
                margin-bottom: 30px;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .word-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <h1>法语词汇分类与记忆系统</h1>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="flex space-between mb-20">
            <!-- Control Panel -->
            <div class="card">
                <div class="flex space-between align-center">
                    <div>
                        <button id="addWordBtn" class="btn btn-accent">添加单词</button>
                        <button id="manageCategoriesBtn" class="btn">管理分类</button>
                    </div>
                    <div>
                        <button id="exportBtn" class="btn">导出词库</button>
                        <button id="importBtn" class="btn">导入词库</button>
                        <button id="startQuizBtn" class="btn btn-success">开始测验</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex space-between">
            <!-- Sidebar with Categories -->
            <div class="col-1-3 sidebar">
                <h3>词汇分类</h3>
                <ul class="category-list" id="categoryList">
                    <li class="category-item active" data-category="all">所有单词</li>
                    <li class="category-item" data-category="learning">正在学习</li>
                    <li class="category-item" data-category="mastered">已掌握</li>
                    <li class="category-item has-children" data-category="economy">
                        经济
                        <ul class="sub-category">
                            <li class="category-item" data-category="economy-macro">宏观经济</li>
                            <li class="category-item" data-category="economy-micro">微观经济</li>
                            <li class="category-item" data-category="economy-finance">金融市场</li>
                        </ul>
                    </li>
                    <li class="category-item has-children" data-category="management">
                        管理
                        <ul class="sub-category">
                            <li class="category-item" data-category="management-hr">人力资源</li>
                            <li class="category-item" data-category="management-strategy">战略管理</li>
                        </ul>
                    </li>
                    <li class="category-item" data-category="transportation">交通</li>
                    <li class="category-item" data-category="education">教育</li>
                </ul>
            </div>

            <!-- Main Content Area -->
            <div class="col-2-3">
                <!-- Search Bar -->
                <div class="search-bar">
                    <input type="text" id="searchInput" class="search-input" placeholder="搜索单词、释义或例句...">
                </div>

                <!-- Word List -->
                <div class="word-list" id="wordList">
                    <!-- Words will be dynamically added here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Add Word Modal -->
    <div id="addWordModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>添加新单词</h2>
            <form id="addWordForm">
                <div class="form-group">
                    <label for="word">法语单词</label>
                    <div class="flex space-between">
                        <input type="text" id="word" class="form-control" style="width: 70%;" required>
                        <button type="button" id="autoFillBtn" class="btn btn-accent">自动填充</button>
                    </div>
                </div>
                <div class="form-group">
                    <label for="phonetic">音标</label>
                    <input type="text" id="phonetic" class="form-control">
                </div>
                <div class="form-group">
                    <label for="translation">释义</label>
                    <input type="text" id="translation" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="example">例句</label>
                    <textarea id="example" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="category">分类</label>
                    <select id="category" class="form-control" required>
                        <option value="">选择分类</option>
                        <option value="economy-macro">经济 - 宏观经济</option>
                        <option value="economy-micro">经济 - 微观经济</option>
                        <option value="economy-finance">经济 - 金融市场</option>
                        <option value="management-hr">管理 - 人力资源</option>
                        <option value="management-strategy">管理 - 战略管理</option>
                        <option value="transportation">交通</option>
                        <option value="education">教育</option>
                    </select>
                    <button type="button" id="autoClassifyBtn" class="btn btn-accent mt-20">自动分类</button>
                </div>
                <div class="form-group">
                    <label for="relatedWords">相关词汇（用逗号分隔）</label>
                    <input type="text" id="relatedWords" class="form-control" placeholder="近义词、反义词或搭配词...">
                </div>
                <div class="form-group">
                    <label for="status">学习状态</label>
                    <select id="status" class="form-control">
                        <option value="learning">正在学习</option>
                        <option value="mastered">已掌握</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-accent">保存单词</button>
            </form>
        </div>
    </div>

    <!-- Manage Categories Modal -->
    <div id="manageCategoriesModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>管理分类</h2>
            <div class="tabs">
                <div class="tab active" data-tab="existingCategories">现有分类</div>
                <div class="tab" data-tab="addCategory">添加分类</div>
                <div class="tab" data-tab="aiSuggestCategory">AI推荐分类</div>
            </div>
            <div class="tab-content active" id="existingCategories">
                <ul id="categoryManagementList" class="category-list">
                    <!-- Categories will be dynamically added here -->
                </ul>
            </div>
            <div class="tab-content" id="addCategory">
                <form id="addCategoryForm">
                    <div class="form-group">
                        <label for="categoryName">分类名称</label>
                        <input type="text" id="categoryName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="parentCategory">父分类（可选）</label>
                        <select id="parentCategory" class="form-control">
                            <option value="">无（顶级分类）</option>
                            <!-- Parent categories will be dynamically added here -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-accent">添加分类</button>
                </form>
            </div>
            <div class="tab-content" id="aiSuggestCategory">
                <p>输入法语单词，AI将识别并推荐适合的分类</p>
                <div class="form-group">
                    <label for="aiCategoryWord">法语单词</label>
                    <input type="text" id="aiCategoryWord" class="form-control" placeholder="输入法语单词...">
                </div>
                <div class="form-group">
                    <label for="aiCategoryTranslation">中文释义（可选）</label>
                    <input type="text" id="aiCategoryTranslation" class="form-control" placeholder="输入中文释义...">
                </div>
                <button id="aiSuggestCategoryBtn" class="btn btn-accent">获取分类建议</button>
                
                <div id="categoryResults" style="margin-top: 20px; display: none;">
                    <h3>AI推荐分类：</h3>
                    <div id="suggestedCategories" class="mt-20">
                        <!-- Suggested categories will appear here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>导入词库</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="importJson">导入完整词库</div>
                <div class="tab" data-tab="importCsv">批量导入词汇</div>
            </div>
            
            <div class="tab-content active" id="importJson">
                <p>请选择之前导出的JSON文件:</p>
                <div class="form-group">
                    <input type="file" id="importFile" accept=".json">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="mergeExisting" checked>
                        合并到现有词库（如不选择则会覆盖现有词库）
                    </label>
                </div>
                <button id="confirmImportBtn" class="btn btn-accent">导入</button>
            </div>
            
            <div class="tab-content" id="importCsv">
                <p>批量导入单词并自动填充信息</p>
                
                <div class="tabs" style="border-bottom: 1px solid #eee; margin-bottom: 15px;">
                    <div class="tab active" data-tab="csvFileImport">上传文件导入</div>
                    <div class="tab" data-tab="csvTextImport">直接输入词汇</div>
                </div>
                
                <div id="csvImportContent">
                    <div class="sub-tab-content active" id="csvFileImport">
                        <p>请上传CSV文件，文件格式要求：</p>
                        <ol style="margin-left: 20px; margin-bottom: 15px;">
                            <li>第一列：法语单词</li>
                            <li>第二列：中文释义（可选）</li>
                        </ol>
                        <div class="form-group">
                            <input type="file" id="importCsvFile" accept=".csv,.txt">
                        </div>
                    </div>
                    
                    <div class="sub-tab-content" id="csvTextImport">
                        <p>请直接输入法语单词，每行一个词汇：</p>
                        <div class="form-group">
                            <textarea id="importWordText" class="form-control" rows="10" placeholder="économie&#13;&#10;marché&#13;&#10;gestion&#13;&#10;..."></textarea>
                        </div>
                        <div class="form-group">
                            <button id="cleanupTextBtn" class="btn">清理文本</button>
                            <span id="cleanupStatus" style="margin-left: 10px; display: none; color: var(--success);">✓ 已清理</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoFillCsvWords" checked>
                            自动填充单词的音标、释义和例句
                        </label>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="autoClassifyCsvWords" checked>
                            自动分类导入的单词
                        </label>
                    </div>
                    <button id="confirmCsvImportBtn" class="btn btn-accent">开始导入</button>
                    
                    <div id="importProgress" style="margin-top: 20px; display: none;">
                        <h4>导入进度</h4>
                        <div style="background-color: #f0f0f0; border-radius: 4px; height: 20px; overflow: hidden;">
                            <div id="importProgressBar" style="background-color: var(--primary-color); height: 100%; width: 0%;"></div>
                        </div>
                        <p id="importStatus" style="margin-top: 10px;"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // API Configuration 
    const API_CONFIG = {
        url: 'https://api.aigc.bar/v1/chat/completions',
        apiKey: 'sk-G8fwDqN0IaB0hayInoXa7I72vwSdd9V4C2K9c1wwmncvEHjH'
    };
    
    // 处理文本的函数
    function processTextWithApiKey() {
        const textArea = document.getElementById('importWordText');
        const cleanupStatus = document.getElementById('cleanupStatus');
        const inputText = textArea.value.trim();
        
        if (!inputText) {
            alert('请先输入文本内容');
            return;
        }
        
        cleanupStatus.textContent = "处理中...";
        cleanupStatus.style.display = 'inline';
        document.getElementById('cleanupTextBtn').disabled = true;
        
        // 调用API
        fetch(API_CONFIG.url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_CONFIG.apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-3.5-turbo',
                messages: [
                    {
                        role: 'system',
                        content: '你是一个专业的法语文本处理助手。请从用户输入的文本中提取所有法语单词和词组，每行一个词条。如果遇到带词性标注的词条(如v.t.、n.m.、adj.等)，请保留并格式化为"单词 词性"的形式。如果词条后有中文释义，不要保留。你的输出应该是一个干净的法语词汇列表，每行一个词条。'
                    },
                    {
                        role: 'user',
                        content: `请处理以下文本，提取所有法语单词和词组，每行返回一个词条：\n\n${inputText}`
                    }
                ],
                temperature: 0.3
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            const cleanedText = result.choices[0].message.content.trim();
            
            // 更新文本区域
            textArea.value = cleanedText;
            
            // 显示成功状态
            cleanupStatus.textContent = "✓ 已清理";
            cleanupStatus.style.color = "var(--success)";
            
            // 3秒后隐藏状态指示器
            setTimeout(() => {
                cleanupStatus.style.display = 'none';
            }, 3000);
        })
        .catch(error => {
            console.error('Error processing text:', error);
            
            // 显示错误状态
            cleanupStatus.textContent = "✗ 处理失败";
            cleanupStatus.style.color = "var(--danger)";
            
            // 本地处理文本
            processTextLocally(inputText, textArea);
            
            // 3秒后隐藏状态指示器
            setTimeout(() => {
                cleanupStatus.style.display = 'none';
            }, 3000);
        })
        .finally(() => {
            document.getElementById('cleanupTextBtn').disabled = false;
        });
    }
    
    // 本地处理文本（作为备用方法）
    function processTextLocally(text, textArea) {
        // 1. 将多个空格替换为单个空格
        text = text.replace(/\s+/g, ' ');
        
        // 2. 按行分割
        const lines = text.split(/[\n\r]+/);
        
        // 3. 提取法语单词和词组
        const frenchWords = [];
        
        lines.forEach(line => {
            // 跳过空行
            if (!line.trim()) return;
            
            // 处理每一行
            // 匹配法语单词或词组，可能带有词性标注(如v.t.、n.m.等)
            const matches = line.match(/([a-záàâäæçéèêëîïôœùûüÿçÀÂÄÆÇÉÈÊËÎÏÔŒÙÛÜŸ'\-]+(?:\s+[a-záàâäæçéèêëîïôœùûüÿçÀÂÄÆÇÉÈÊËÎÏÔŒÙÛÜŸ'\-]+)*(?:\s+[a-z]+\.[a-z]+\.?)?)/gi);
            
            if (matches) {
                // 添加所有匹配项
                matches.forEach(match => {
                    const word = match.trim();
                    if (word && word.length > 1 && !frenchWords.includes(word)) {
                        frenchWords.push(word);
                    }
                });
            }
        });
        
        // 4. 更新文本区域
        textArea.value = frenchWords.join('\n');
    }
    
    // 使用API增强单词详情
    function enhanceWordDetails(word) {
        // 如果word是CSV解析的对象
        const wordText = typeof word === 'object' ? word.word : word;
        
        return fetch(API_CONFIG.url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${API_CONFIG.apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-3.5-turbo',
                messages: [
                    {
                        role: 'system',
                        content: '你是一个法语学习助手。请提供以下法语单词的详细信息，包括音标、中文释义、词性和2个例句。'
                    },
                    {
                        role: 'user',
                        content: `请提供法语单词 "${wordText}" 的详细信息，格式为JSON：
                        {
                            "word": "单词",
                            "phonetic": "音标",
                            "translation": "中文释义",
                            "partOfSpeech": "词性",
                            "examples": ["例句1", "例句2"]
                        }`
                    }
                ]
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            const content = result.choices[0].message.content;
            
            // 从响应中提取JSON
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (jsonMatch) {
                return JSON.parse(jsonMatch[0]);
            } else {
                throw new Error('Could not parse API response');
            }
        })
        .catch(error => {
            console.error(`Error enhancing word "${wordText}":`, error);
            // 返回基本结构
            return {
                word: wordText,
                phonetic: "",
                translation: typeof word === 'object' ? word.translation : "",
                partOfSpeech: "",
                examples: []
            };
        });
    }
    
    // 连接按钮到现有逻辑
    document.addEventListener('DOMContentLoaded', function() {
        // 连接清理按钮到API函数
        const cleanupBtn = document.getElementById('cleanupTextBtn');
        if (cleanupBtn) {
            // 保留任何现有的onclick处理程序
            const originalOnClick = cleanupBtn.onclick;
            cleanupBtn.onclick = function() {
                if (typeof originalOnClick === 'function') {
                    originalOnClick.call(this);
                }
                processTextWithApiKey();
            };
        }
        
        // 修改现有导入函数以在需要时使用enhanceWordDetails
        // 这假设你有一个处理单词的现有导入函数
        // 当autoFill被选中时，你需要为每个单词调用enhanceWordDetails()
    });
    
    // 按顺序处理单词的辅助函数
    async function processWordsSequentially(words, autoFill) {
        const results = [];
        for (const word of words) {
            if (autoFill) {
                const enhancedWord = await enhanceWordDetails(word);
                results.push(enhancedWord);
            } else {
                results.push(word);
            }
        }
        return results;
    }
    </script>

    <script>
        function processTextWithApiKey() {
            const textArea = document.getElementById('importWordText');
            const statusIndicator = document.getElementById('cleanupStatus');
            const apiKey = 'YOUR_API_KEY_HERE'; // 请替换为实际的API密钥

            if (!textArea.value.trim()) {
                alert('请先输入文本');
                return;
            }

            statusIndicator.textContent = "处理中...";
            statusIndicator.style.display = 'inline';

            // 使用API智能处理文本
            fetch('https://api.example.com/process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({ text: textArea.value })
            })
            .then(response => response.json())
            .then(data => {
                textArea.value = data.cleanedText;
                statusIndicator.textContent = "✓ 已清理";
                statusIndicator.style.color = "var(--success)";
                setTimeout(() => {
                    statusIndicator.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('处理文本出错:', error);
                statusIndicator.textContent = "✗ 处理失败";
                statusIndicator.style.color = "var(--danger)";
                setTimeout(() => {
                    statusIndicator.style.display = 'none';
                }, 3000);
            });
        }
    </script>

    <!-- Quiz Modal -->
    <div id="quizModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>词汇测验</h2>
            <div class="quiz-container" id="quizContainer">
                <div id="quizSetup">
                    <div class="form-group">
                        <label for="quizCategory">选择分类</label>
                        <select id="quizCategory" class="form-control">
                            <option value="all">所有单词</option>
                            <!-- Categories will be dynamically added here -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quizType">测验类型</label>
                        <select id="quizType" class="form-control">
                            <option value="fr-to-zh">法语 → 中文</option>
                            <option value="zh-to-fr">中文 → 法语</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quizCount">题目数量</label>
                        <select id="quizCount" class="form-control">
                            <option value="5">5题</option>
                            <option value="10" selected>10题</option>
                            <option value="20">20题</option>
                        </select>
                    </div>
                    <button id="startQuizNowBtn" class="btn btn-accent">开始测验</button>
                </div>

                <div id="quizQuestions" style="display: none;">
                    <div id="questionContainer">
                        <h3 id="quizQuestion"></h3>
                        <ul class="quiz-options" id="quizOptions">
                            <!-- Options will be dynamically added here -->
                        </ul>
                    </div>
                    <div class="quiz-progress">
                        <div class="quiz-progress-bar" id="quizProgressBar"></div>
                    </div>
                    <div class="mt-20">
                        <button id="nextQuestionBtn" class="btn btn-accent" style="display: none;">下一题</button>
                        <button id="finishQuizBtn" class="btn btn-success" style="display: none;">完成测验</button>
                    </div>
                </div>

                <div id="quizResults" style="display: none;">
                    <h3>测验结果</h3>
                    <p>得分: <span id="quizScore">0</span> / <span id="quizTotal">0</span></p>
                    <div id="quizResultsList">
                        <!-- Results will be dynamically added here -->
                    </div>
                    <button id="restartQuizBtn" class="btn btn-accent mt-20">重新测验</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 确保在页面完全加载后运行所有代码
        document.addEventListener('DOMContentLoaded', function() {
        // Main App Class
        class VocabApp {
            constructor() {
                this.words = [];
                this.categories = [];
                this.currentCategory = 'all';
                this.currentFilter = '';
                
                // API配置
                this.apiKey = 'sk-G8fwDqN0IaB0hayInoXa7I72vwSdd9V4C2K9c1wwmncvEHjH';
                this.apiUrl = 'https://api.aigc.bar/v1/chat/completions';
                
                // Initialize the app
                this.init();
            }
            
            // Initialize the app
            init() {
                // Load data from localStorage
                this.loadData();
                
                // Setup event listeners
                this.setupEventListeners();
                
                // Render initial UI
                this.renderCategories();
                this.renderWords();
                
                // Setup quiz module
                this.quizModule = new QuizModule(this);
                
                // 添加页面重新加载时刷新左侧分类列表的事件
                window.addEventListener('load', () => {
                    this.renderCategories();
                    this.renderWords();
                });
            }
            
            // Load data from localStorage
            loadData() {
                try {
                    // Load words
                    const savedWords = localStorage.getItem('frenchVocabWords');
                    if (savedWords) {
                        this.words = JSON.parse(savedWords);
                    } else {
                        // Initialize with sample data if no saved data
                        this.loadSampleData();
                    }
                    
                    // Load categories
                    const savedCategories = localStorage.getItem('frenchVocabCategories');
                    if (savedCategories) {
                        this.categories = JSON.parse(savedCategories);
                    } else {
                        // Initialize with default categories
                        this.initializeDefaultCategories();
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    // Fall back to sample data
                    this.loadSampleData();
                    this.initializeDefaultCategories();
                }
            }
            
            // Load sample data for demonstration
            loadSampleData() {
                this.words = [
                    {
                        id: 1,
                        word: 'économie',
                        phonetic: '/ekɔnɔmi/',
                        translation: '经济',
                        example: "L'économie française a connu une croissance de 2% cette année.",
                        category: 'economy-macro',
                        relatedWords: 'économique, économiser',
                        status: 'learning',
                        lastReviewed: new Date().toISOString(),
                        nextReview: new Date(Date.now() + 86400000).toISOString() // Next day
                    },
                    {
                        id: 2,
                        word: 'gestion',
                        phonetic: '/ʒɛstjɔ̃/',
                        translation: '管理',
                        example: "La gestion efficace des ressources est essentielle pour toute entreprise.",
                        category: 'management-strategy',
                        relatedWords: 'gérer, gestionnaire',
                        status: 'learning',
                        lastReviewed: new Date().toISOString(),
                        nextReview: new Date(Date.now() + 86400000).toISOString()
                    },
                    {
                        id: 3,
                        word: 'marché',
                        phonetic: '/maʁʃe/',
                        translation: '市场',
                        example: "Le marché boursier a chuté de 5% hier.",
                        category: 'economy-finance',
                        relatedWords: 'commercial, marchandise',
                        status: 'mastered',
                        lastReviewed: new Date().toISOString(),
                        nextReview: new Date(Date.now() + 259200000).toISOString() // 3 days later
                    }
                ];
                
                // Save to localStorage
                this.saveData();
            }
            
            // Initialize default categories
            initializeDefaultCategories() {
                this.categories = [
                    {
                        id: 'economy',
                        name: '经济',
                        parent: null,
                        children: ['economy-macro', 'economy-micro', 'economy-finance']
                    },
                    {
                        id: 'economy-macro',
                        name: '宏观经济',
                        parent: 'economy',
                        children: []
                    },
                    {
                        id: 'economy-micro',
                        name: '微观经济',
                        parent: 'economy',
                        children: []
                    },
                    {
                        id: 'economy-finance',
                        name: '金融市场',
                        parent: 'economy',
                        children: []
                    },
                    {
                        id: 'management',
                        name: '管理',
                        parent: null,
                        children: ['management-hr', 'management-strategy']
                    },
                    {
                        id: 'management-hr',
                        name: '人力资源',
                        parent: 'management',
                        children: []
                    },
                    {
                        id: 'management-strategy',
                        name: '战略管理',
                        parent: 'management',
                        children: []
                    },
                    {
                        id: 'transportation',
                        name: '交通',
                        parent: null,
                        children: []
                    },
                    {
                        id: 'education',
                        name: '教育',
                        parent: null,
                        children: []
                    }
                ];
                
                // Save to localStorage
                localStorage.setItem('frenchVocabCategories', JSON.stringify(this.categories));
            }
            
            // Save data to localStorage
            saveData() {
                localStorage.setItem('frenchVocabWords', JSON.stringify(this.words));
                localStorage.setItem('frenchVocabCategories', JSON.stringify(this.categories));
            }
            
            // Setup event listeners
            setupEventListeners() {
                // Category selection
                document.getElementById('categoryList').addEventListener('click', (e) => {
                    const item = e.target.closest('.category-item');
                    if (item) {
                        // Handle category selection
                        if (item.classList.contains('has-children')) {
                            const subCategory = item.querySelector('.sub-category');
                            if (subCategory) {
                                subCategory.classList.toggle('show');
                            }
                        } else {
                            // Remove active class from all items
                            document.querySelectorAll('.category-item').forEach(item => {
                                item.classList.remove('active');
                            });
                            
                            // Add active class to clicked item
                            item.classList.add('active');
                            
                            // Update current category and render words
                            this.currentCategory = item.dataset.category;
                            this.renderWords();
                        }
                    }
                });
                
                // Search input
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    this.currentFilter = e.target.value.toLowerCase();
                    this.renderWords();
                });
                
                // Add word button
                document.getElementById('addWordBtn').addEventListener('click', () => {
                    this.openModal('addWordModal');
                });
                
                // Add word form submission
                document.getElementById('addWordForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addWord();
                });
                
                // Manage categories button
                document.getElementById('manageCategoriesBtn').addEventListener('click', () => {
                    this.renderCategoryManagement();
                    this.openModal('manageCategoriesModal');
                });
                
                // Add category form submission
                document.getElementById('addCategoryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addCategory();
                });
                
                // Tab switching in modals
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        
                        // Remove active class from all tabs and contents
                        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        // Add active class to clicked tab
                        tab.classList.add('active');
                        
                        // Show corresponding tab content
                        document.getElementById(tabName).classList.add('active');
                    });
                });
                
                // Auto classify button
                document.getElementById('autoClassifyBtn').addEventListener('click', () => {
                    this.autoClassifyWord();
                });
                
                // Auto fill button
                document.getElementById('autoFillBtn').addEventListener('click', () => {
                    this.autoFillWord();
                });
                
                // 添加AI推荐分类按钮事件
                document.getElementById('aiSuggestCategoryBtn').addEventListener('click', () => {
                    this.getAiCategorySuggestions();
                });
                
                // 添加导出词库按钮事件
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.exportVocab();
                });
                
                // 添加导入词库按钮事件
                document.getElementById('importBtn').addEventListener('click', () => {
                    this.openModal('importModal');
                });
                
                // 添加确认导入按钮事件
                document.getElementById('confirmImportBtn').addEventListener('click', () => {
                    this.importVocab();
                });
                
                // 添加CSV导入按钮事件
                document.getElementById('confirmCsvImportBtn').addEventListener('click', () => {
                    this.importCsvVocab();
                });
                
                // 添加文本清理按钮事件
                document.getElementById('cleanupTextBtn').addEventListener('click', () => {
                    this.cleanupImportText();
                });
                
                // 导入模态框内的选项卡切换
                document.querySelectorAll('#importCsv .tabs .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        
                        // 移除所有选项卡的活动状态
                        document.querySelectorAll('#importCsv .tabs .tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        // 移除所有内容的活动状态
                        document.querySelectorAll('#importCsv .sub-tab-content').forEach(c => {
                            c.classList.remove('active');
                        });
                        
                        // 激活当前选项卡
                        tab.classList.add('active');
                        document.getElementById(tabName).classList.add('active');
                    });
                });
                
                // 顶层导入模态框选项卡切换
                document.querySelectorAll('#importModal > .modal-content > .tabs > .tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const tabName = tab.dataset.tab;
                        
                        // 移除所有选项卡的活动状态
                        document.querySelectorAll('#importModal > .modal-content > .tabs > .tab').forEach(t => {
                            t.classList.remove('active');
                        });
                        
                        // 移除所有内容的活动状态
                        document.querySelectorAll('#importModal > .modal-content > .tab-content').forEach(c => {
                            c.classList.remove('active');
                        });
                        
                        // 激活当前选项卡
                        tab.classList.add('active');
                        document.getElementById(tabName).classList.add('active');
                    });
                });
            }
            
            // Auto classify method
            autoClassifyWord() {
                const wordInput = document.getElementById('word').value.trim();
                const translationInput = document.getElementById('translation').value.trim();
                
                if (!wordInput) {
                    alert('请先输入法语单词');
                    return;
                }
                
                // 显示加载状态
                document.getElementById('autoClassifyBtn').textContent = '分类中...';
                document.getElementById('autoClassifyBtn').disabled = true;
                
                // 准备请求数据
                const requestData = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: "你是一个专业的法语词汇分类助手。请根据输入的法语单词及其中文含义，将其分类到以下类别之一：economy-macro（宏观经济）, economy-micro（微观经济）, economy-finance（金融市场）, management-hr（人力资源）, management-strategy（战略管理）, transportation（交通）, education（教育）。只需返回分类ID，不要解释。"
                        },
                        {
                            role: "user",
                            content: `法语单词: ${wordInput}, 中文释义: ${translationInput || '未提供'}`
                        }
                    ],
                    temperature: 0.2
                };
                
                // 发送请求
                fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API 请求失败：' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // 处理返回结果
                    if (data.choices && data.choices.length > 0) {
                        const categoryResponse = data.choices[0].message.content.trim();
                        
                        // 检查返回的分类是否在我们的列表中
                        const validCategories = [
                            'economy-macro', 'economy-micro', 'economy-finance',
                            'management-hr', 'management-strategy',
                            'transportation', 'education'
                        ];
                        
                        // 尝试从响应中提取有效分类
                        let foundCategory = null;
                        for (const category of validCategories) {
                            if (categoryResponse.includes(category)) {
                                foundCategory = category;
                                break;
                            }
                        }
                        
                        // 如果找到有效分类，则设置下拉框值
                        if (foundCategory) {
                            document.getElementById('category').value = foundCategory;
                        } else {
                            // 本地备用分类逻辑
                            this.performLocalClassification(wordInput, translationInput);
                        }
                    } else {
                        throw new Error('API 返回结果异常');
                    }
                })
                .catch(error => {
                    console.error('API 请求错误:', error);
                    // 使用本地分类作为备用
                    this.performLocalClassification(wordInput, translationInput);
                })
                .finally(() => {
                    // 恢复按钮状态
                    document.getElementById('autoClassifyBtn').textContent = '自动分类';
                    document.getElementById('autoClassifyBtn').disabled = false;
                });
            }

            // 本地分类备用方法
            performLocalClassification(wordInput, translationInput) {
                // 分类关键词字典
                const categoryKeywords = {
                    'economy-macro': ['économie', 'pib', 'inflation', 'croissance', '经济', '增长', '通胀', 'marché', '市场'],
                    'economy-finance': ['finance', 'bourse', 'banque', '金融', '银行', 'investissement', '投资'],
                    'economy-micro': ['entreprise', 'prix', 'offre', 'demande', '企业', '价格', '供应', '需求'],
                    'management-hr': ['ressources humaines', 'recrutement', 'employé', '人力资源', '招聘', '员工'],
                    'management-strategy': ['stratégie', 'gestion', 'objectif', '战略', '管理', '目标'],
                    'transportation': ['transport', 'voiture', 'train', 'avion', '交通', '汽车', '火车', '飞机'],
                    'education': ['éducation', 'école', 'université', '教育', '学校', '大学']
                };
                
                // 搜索文本是单词和翻译的组合
                const searchText = (wordInput + ' ' + translationInput).toLowerCase();
                
                // 对每个类别计算匹配分数
                const categoryScores = {};
                
                for (const [category, keywords] of Object.entries(categoryKeywords)) {
                    categoryScores[category] = 0;
                    
                    for (const keyword of keywords) {
                        if (searchText.includes(keyword)) {
                            categoryScores[category] += 1;
                        }
                    }
                }
                
                // 找出得分最高的类别
                let highestScore = 0;
                let suggestedCategory = '';
                
                for (const [category, score] of Object.entries(categoryScores)) {
                    if (score > highestScore) {
                        highestScore = score;
                        suggestedCategory = category;
                    }
                }
                
                // 设置分类下拉框的值
                if (suggestedCategory && highestScore > 0) {
                    document.getElementById('category').value = suggestedCategory;
                } else {
                    alert('无法自动确定分类，请手动选择');
                }
            }

            // 自动填充单词信息
            autoFillWord() {
                const wordInput = document.getElementById('word').value.trim();
                
                if (!wordInput) {
                    alert('请先输入法语单词');
                    return;
                }
                
                // 显示加载状态
                document.getElementById('autoFillBtn').textContent = '加载中...';
                document.getElementById('autoFillBtn').disabled = true;
                
                // 准备请求数据
                const requestData = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: "你是一个专业的法语词典助手。请提供输入的法语单词的音标、中文释义和例句。请按照以下JSON格式返回结果：{\"phonetic\": \"音标\", \"translation\": \"中文释义\", \"example\": \"法语例句\"}"
                        },
                        {
                            role: "user",
                            content: `请提供法语单词"${wordInput}"的音标、中文释义和例句`
                        }
                    ],
                    temperature: 0.3
                };
                
                // 发送请求
                fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API 请求失败：' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    try {
                        // 尝试解析返回的结果
                        let result;
                        const content = data.choices[0].message.content;
                        
                        // 尝试提取JSON部分
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            result = JSON.parse(jsonMatch[0]);
                        } else {
                            throw new Error('无法解析返回结果');
                        }
                        
                        // 填充表单
                        if (result.phonetic) {
                            document.getElementById('phonetic').value = result.phonetic;
                        }
                        if (result.translation) {
                            document.getElementById('translation').value = result.translation;
                        }
                        if (result.example) {
                            document.getElementById('example').value = result.example;
                        }
                        
                        // 如果有了翻译，也可以自动触发分类
                        if (result.translation) {
                            this.autoClassifyWord();
                        }
                    } catch (error) {
                        console.error('解析API返回结果出错:', error);
                        alert('无法解析API返回的结果，请手动填写');
                    }
                })
                .catch(error => {
                    console.error('API 请求错误:', error);
                    alert('获取单词信息失败，请手动填写');
                })
                .finally(() => {
                    // 恢复按钮状态
                    document.getElementById('autoFillBtn').textContent = '自动填充';
                    document.getElementById('autoFillBtn').disabled = false;
                });
            }

            // 打开模态框函数
            openModal(modalId) {
                document.getElementById(modalId).style.display = 'block';
                
                // 如果是添加单词模态框，更新分类下拉列表
                if (modalId === 'addWordModal') {
                    this.updateCategoryDropdown();
                }
            }
            
            // 关闭模态框函数
            closeModal(modalId) {
                document.getElementById(modalId).style.display = 'none';
            }
            
            // 更新分类下拉列表
            updateCategoryDropdown() {
                const categorySelect = document.getElementById('category');
                categorySelect.innerHTML = '<option value="">选择分类</option>';
                
                // 按照分类层次结构添加选项
                this.categories.forEach(category => {
                    if (!category.parent) { // 顶级分类
                        // 跳过特殊分类
                        if (category.id === 'learning' || category.id === 'mastered' || category.id === 'all') {
                            return;
                        }
                        
                        // 添加子分类
                        if (category.children && category.children.length > 0) {
                            category.children.forEach(childId => {
                                const childCategory = this.categories.find(c => c.id === childId);
                                if (childCategory) {
                                    const option = document.createElement('option');
                                    option.value = childCategory.id;
                                    option.textContent = `${category.name} - ${childCategory.name}`;
                                    categorySelect.appendChild(option);
                                }
                            });
                        } else {
                            // 没有子分类的顶级分类
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            categorySelect.appendChild(option);
                        }
                    }
                });
            }
            
            // 渲染单词列表
            renderWords() {
                const wordListEl = document.getElementById('wordList');
                wordListEl.innerHTML = '';
                
                // 过滤单词
                let filteredWords = this.words;
                
                // 按分类过滤
                if (this.currentCategory !== 'all') {
                    if (this.currentCategory === 'learning' || this.currentCategory === 'mastered') {
                        filteredWords = filteredWords.filter(word => word.status === this.currentCategory);
                    } else {
                        filteredWords = filteredWords.filter(word => word.category === this.currentCategory);
                    }
                }
                
                // 按搜索关键词过滤
                if (this.currentFilter) {
                    filteredWords = filteredWords.filter(word => 
                        word.word.toLowerCase().includes(this.currentFilter) ||
                        word.translation.toLowerCase().includes(this.currentFilter) ||
                        (word.example && word.example.toLowerCase().includes(this.currentFilter))
                    );
                }
                
                // 显示过滤后的单词
                if (filteredWords.length === 0) {
                    wordListEl.innerHTML = '<p>没有找到符合条件的单词</p>';
                    return;
                }
                
                // 渲染每个单词卡片
                filteredWords.forEach(word => {
                    const category = this.categories.find(c => c.id === word.category);
                    const categoryName = category ? category.name : '未分类';
                    
                    const wordCard = document.createElement('div');
                    wordCard.className = 'word-card';
                    wordCard.innerHTML = `
                        <h3>${word.word}</h3>
                        <div class="phonetic">${word.phonetic || ''}</div>
                        <div class="translation">${word.translation}</div>
                        ${word.example ? `<div class="example">${word.example}</div>` : ''}
                        <div>
                            <span class="category-tag">${categoryName}</span>
                        </div>
                        <div class="status-badge status-${word.status}">
                            ${word.status === 'learning' ? '学习中' : '已掌握'}
                        </div>
                        <div class="word-actions" style="margin-top: 10px; text-align: right;">
                            <button class="btn btn-warning edit-word-btn">编辑</button>
                            <button class="btn btn-danger delete-word-btn">删除</button>
                        </div>
                    `;
                    
                    wordCard.querySelector('.edit-word-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.editWord(word);
                    });
                    
                    wordCard.querySelector('.delete-word-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`确定要删除单词 "${word.word}" 吗？`)) {
                            this.words = this.words.filter(w => w.id !== word.id);
                            this.saveData();
                            this.renderWords();
                        }
                    });
                    
                    wordListEl.appendChild(wordCard);
                });
            }
            
            // 编辑单词
            editWord(word) {
                // 打开添加单词模态框并填充数据
                this.openModal('addWordModal');
                
                // 将模态框标题修改为编辑
                document.querySelector('#addWordModal h2').textContent = '编辑单词';
                
                // 填充表单数据
                document.getElementById('word').value = word.word;
                document.getElementById('phonetic').value = word.phonetic || '';
                document.getElementById('translation').value = word.translation;
                document.getElementById('example').value = word.example || '';
                document.getElementById('relatedWords').value = word.relatedWords || '';
                document.getElementById('status').value = word.status;
                
                // 确保分类下拉列表已更新
                this.updateCategoryDropdown();
                
                // 设置分类
                setTimeout(() => {
                    document.getElementById('category').value = word.category;
                }, 50);
                
                // 更改提交按钮行为
                const submitButton = document.querySelector('#addWordForm button[type="submit"]');
                submitButton.textContent = '保存修改';
                
                // 添加删除按钮
                let deleteButton = document.getElementById('deleteWordBtn');
                if (!deleteButton) {
                    deleteButton = document.createElement('button');
                    deleteButton.id = 'deleteWordBtn';
                    deleteButton.className = 'btn btn-danger';
                    deleteButton.style.marginLeft = '10px';
                    deleteButton.textContent = '删除单词';
                    submitButton.parentNode.appendChild(deleteButton);
                }
                
                // 移除之前可能存在的编辑事件监听器
                if (this.editSubmitHandler) {
                    document.getElementById('addWordForm').removeEventListener('submit', this.editSubmitHandler);
                }
                
                if (this.deleteWordHandler) {
                    deleteButton.removeEventListener('click', this.deleteWordHandler);
                }
                
                // 为提交按钮添加编辑事件处理器
                this.editSubmitHandler = (e) => {
                    e.preventDefault();
                    
                    // 更新单词数据
                    const index = this.words.findIndex(w => w.id === word.id);
                    if (index !== -1) {
                        this.words[index] = {
                            ...this.words[index],
                            word: document.getElementById('word').value.trim(),
                            phonetic: document.getElementById('phonetic').value.trim(),
                            translation: document.getElementById('translation').value.trim(),
                            example: document.getElementById('example').value.trim(),
                            category: document.getElementById('category').value,
                            relatedWords: document.getElementById('relatedWords').value.trim(),
                            status: document.getElementById('status').value,
                            lastReviewed: new Date().toISOString(),
                        };
                        
                        this.saveData();
                        this.renderWords();
                        
                        // 重置表单并关闭模态框
                        document.getElementById('addWordForm').reset();
                        this.closeModal('addWordModal');
                        
                        // 恢复添加单词模态框
                        this.resetAddWordModal();
                    }
                };
                
                // 为删除按钮添加事件处理器
                this.deleteWordHandler = () => {
                    if (confirm(`确定要删除单词 "${word.word}" 吗？`)) {
                        // 从单词列表中删除
                        this.words = this.words.filter(w => w.id !== word.id);
                        this.saveData();
                        this.renderWords();
                        
                        // 关闭模态框
                        this.closeModal('addWordModal');
                        
                        // 恢复添加单词模态框
                        this.resetAddWordModal();
                    }
                };
                
                // 添加事件监听器
                document.getElementById('addWordForm').addEventListener('submit', this.editSubmitHandler);
                deleteButton.addEventListener('click', this.deleteWordHandler);
            }
            
            // 重置添加单词模态框
            resetAddWordModal() {
                // 恢复标题
                document.querySelector('#addWordModal h2').textContent = '添加新单词';
                
                // 恢复提交按钮
                const submitButton = document.querySelector('#addWordForm button[type="submit"]');
                submitButton.textContent = '保存单词';
                
                // 移除删除按钮
                const deleteButton = document.getElementById('deleteWordBtn');
                if (deleteButton) {
                    deleteButton.remove();
                }
                
                // 清除编辑事件监听器
                if (this.editSubmitHandler) {
                    document.getElementById('addWordForm').removeEventListener('submit', this.editSubmitHandler);
                    this.editSubmitHandler = null;
                }
                
                // 恢复添加单词事件处理
                document.getElementById('addWordForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addWord();
                });
            }
            
            // 添加单词
            addWord() {
                const word = document.getElementById('word').value.trim();
                const phonetic = document.getElementById('phonetic').value.trim();
                const translation = document.getElementById('translation').value.trim();
                const example = document.getElementById('example').value.trim();
                const category = document.getElementById('category').value;
                const relatedWords = document.getElementById('relatedWords').value.trim();
                const status = document.getElementById('status').value;
                
                if (!word || !translation || !category) {
                    alert('请填写必填字段');
                    return;
                }
                
                const newWord = {
                    id: Date.now(),
                    word,
                    phonetic,
                    translation,
                    example,
                    category,
                    relatedWords,
                    status,
                    lastReviewed: new Date().toISOString(),
                    nextReview: new Date(Date.now() + 86400000).toISOString() // 下一天
                };
                
                this.words.push(newWord);
                this.saveData();
                this.renderWords();
                
                // 重置表单并关闭模态框
                document.getElementById('addWordForm').reset();
                this.closeModal('addWordModal');
            }
            
            // 添加分类
            addCategory() {
                const categoryName = document.getElementById('categoryName').value.trim();
                const parentCategory = document.getElementById('parentCategory').value;
                
                if (!categoryName) {
                    alert('请输入分类名称');
                    return;
                }
                
                // 生成初始ID
                let categoryId = categoryName.toLowerCase().replace(/\s+/g, '-');
                
                // 检查分类ID是否已存在，如果存在则添加数字后缀
                let counter = 1;
                let newCategoryId = categoryId;
                while (this.categories.some(category => category.id === newCategoryId)) {
                    newCategoryId = `${categoryId}-${counter}`;
                    counter++;
                }
                
                // 使用生成的唯一ID
                categoryId = newCategoryId;
                
                const newCategory = {
                    id: categoryId,
                    name: categoryName,
                    parent: parentCategory || null,
                    children: []
                };
                
                // 添加到父分类的 children 中
                if (parentCategory) {
                    const parent = this.categories.find(category => category.id === parentCategory);
                    if (parent) {
                        parent.children.push(categoryId);
                    }
                }
                
                this.categories.push(newCategory);
                this.saveData();
                this.renderCategoryManagement();
                
                // 更新左侧分类列表
                this.renderCategories();
                
                // 重置表单
                document.getElementById('addCategoryForm').reset();
                
                // 切换到现有分类选项卡
                document.querySelector('.tab[data-tab="existingCategories"]').click();
            }
            
            // 编辑分类
            editCategory(categoryId) {
                const category = this.categories.find(category => category.id === categoryId);
                if (!category) return;
                
                const newName = prompt('输入新的分类名称:', category.name);
                if (newName && newName.trim()) {
                    category.name = newName.trim();
                    this.saveData();
                    this.renderCategoryManagement();
                    
                    // 更新左侧分类列表
                    this.renderCategories();
                }
            }
            
            // 删除分类
            deleteCategory(categoryId) {
                const confirmDelete = confirm('确定要删除此分类吗？使用此分类的单词将变为未分类。');
                if (!confirmDelete) return;
                
                const category = this.categories.find(category => category.id === categoryId);
                if (!category) return;
                
                // 如果有父分类，从父分类的 children 中移除
                if (category.parent) {
                    const parent = this.categories.find(c => c.id === category.parent);
                    if (parent) {
                        parent.children = parent.children.filter(id => id !== categoryId);
                    }
                }
                
                // 更新使用此分类的单词
                this.words.forEach(word => {
                    if (word.category === categoryId) {
                        word.category = '';
                    }
                });
                
                // 从分类列表中移除
                this.categories = this.categories.filter(c => c.id !== categoryId);
                
                this.saveData();
                this.renderCategoryManagement();
                this.renderCategories();
                this.renderWords();
            }

            // AI推荐分类方法
            getAiCategorySuggestions() {
                const wordInput = document.getElementById('aiCategoryWord').value.trim();
                const translationInput = document.getElementById('aiCategoryTranslation').value.trim();
                
                if (!wordInput) {
                    alert('请输入法语单词');
                    return;
                }
                
                // 显示加载状态
                document.getElementById('aiSuggestCategoryBtn').textContent = '正在分析...';
                document.getElementById('aiSuggestCategoryBtn').disabled = true;
                
                // 准备请求数据
                const requestData = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: "你是一个专业的法语词汇分类助手。请分析输入的法语单词，并推荐3-5个可能的分类。每个分类应该有一个唯一的ID（英文小写，使用连字符分隔单词）和中文名称。请按照以下JSON格式返回结果：{\"categories\": [{\"id\": \"分类ID\", \"name\": \"分类名称\"}, ...]}"
                        },
                        {
                            role: "user",
                            content: `法语单词: ${wordInput}${translationInput ? ', 中文释义: ' + translationInput : ''}`
                        }
                    ],
                    temperature: 0.3
                };
                
                // 发送请求
                fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API 请求失败：' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    try {
                        // 尝试解析返回的结果
                        let result;
                        const content = data.choices[0].message.content;
                        
                        // 尝试提取JSON部分
                        const jsonMatch = content.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            result = JSON.parse(jsonMatch[0]);
                        } else {
                            throw new Error('无法解析返回结果');
                        }
                        
                        // 显示推荐的分类
                        if (result.categories && result.categories.length > 0) {
                            this.displayCategorySuggestions(result.categories);
                        } else {
                            throw new Error('未找到推荐分类');
                        }
                    } catch (error) {
                        console.error('解析API返回结果出错:', error);
                        alert('无法解析API返回的结果，请手动添加分类');
                    }
                })
                .catch(error => {
                    console.error('API 请求错误:', error);
                    alert('获取分类建议失败，请手动添加分类');
                })
                .finally(() => {
                    // 恢复按钮状态
                    document.getElementById('aiSuggestCategoryBtn').textContent = '获取分类建议';
                    document.getElementById('aiSuggestCategoryBtn').disabled = false;
                });
            }
            
            // 显示分类建议
            displayCategorySuggestions(categories) {
                const resultsContainer = document.getElementById('categoryResults');
                const suggestedCategoriesContainer = document.getElementById('suggestedCategories');
                
                // 清空之前的建议
                suggestedCategoriesContainer.innerHTML = '';
                
                // 显示结果区域
                resultsContainer.style.display = 'block';
                
                // 添加每个建议的分类
                categories.forEach(category => {
                    const categoryCard = document.createElement('div');
                    categoryCard.className = 'card mb-20';
                    categoryCard.innerHTML = `
                        <div class="flex space-between align-center">
                            <div>
                                <strong>${category.name}</strong>
                                <p><small>ID: ${category.id}</small></p>
                            </div>
                            <button class="btn btn-accent add-suggested-category" 
                                    data-id="${category.id}" 
                                    data-name="${category.name}">
                                添加此分类
                            </button>
                        </div>
                    `;
                    
                    suggestedCategoriesContainer.appendChild(categoryCard);
                });
                
                // 添加点击事件到"添加此分类"按钮
                document.querySelectorAll('.add-suggested-category').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const categoryId = btn.dataset.id;
                        const categoryName = btn.dataset.name;
                        this.addSuggestedCategory(categoryId, categoryName);
                    });
                });
            }
            
            // 添加建议的分类
            addSuggestedCategory(categoryId, categoryName) {
                // 生成初始ID
                let newCategoryId = categoryId;
                
                // 检查分类ID是否已存在，如果存在则添加数字后缀
                let counter = 1;
                while (this.categories.some(category => category.id === newCategoryId)) {
                    newCategoryId = `${categoryId}-${counter}`;
                    counter++;
                }
                
                // 创建新分类，使用唯一的ID
                const newCategory = {
                    id: newCategoryId,
                    name: categoryName,
                    parent: null,  // 默认为顶级分类
                    children: []
                };
                
                // 添加到分类列表
                this.categories.push(newCategory);
                this.saveData();
                
                // 更新UI
                this.renderCategoryManagement();
                this.renderCategories();
                
                // 提示用户
                alert(`已成功添加分类"${categoryName}"`);
                
                // 切换到现有分类选项卡
                document.querySelector('.tab[data-tab="existingCategories"]').click();
            }

            // 渲染分类列表
            renderCategories() {
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML = '';
                
                // 添加固定分类
                categoryList.innerHTML += `
                    <li class="category-item ${this.currentCategory === 'all' ? 'active' : ''}" data-category="all">所有单词</li>
                    <li class="category-item ${this.currentCategory === 'learning' ? 'active' : ''}" data-category="learning">正在学习</li>
                    <li class="category-item ${this.currentCategory === 'mastered' ? 'active' : ''}" data-category="mastered">已掌握</li>
                `;
                
                // 添加动态分类
                this.categories.forEach(category => {
                    if (!category.parent && category.id !== 'all' && 
                        category.id !== 'learning' && category.id !== 'mastered') {
                        
                        const hasChildren = category.children && category.children.length > 0;
                        
                        const categoryItem = document.createElement('li');
                        categoryItem.className = `category-item ${hasChildren ? 'has-children' : ''} ${this.currentCategory === category.id ? 'active' : ''}`;
                        categoryItem.dataset.category = category.id;
                        categoryItem.textContent = category.name;
                        
                        // 添加子分类
                        if (hasChildren) {
                            const subCategoryList = document.createElement('ul');
                            subCategoryList.className = `sub-category ${this.isParentOfCurrentCategory(category.id) ? 'show' : ''}`;
                            
                            category.children.forEach(childId => {
                                const childCategory = this.categories.find(c => c.id === childId);
                                if (childCategory) {
                                    const childItem = document.createElement('li');
                                    childItem.className = `category-item ${this.currentCategory === childCategory.id ? 'active' : ''}`;
                                    childItem.dataset.category = childCategory.id;
                                    childItem.textContent = childCategory.name;
                                    subCategoryList.appendChild(childItem);
                                }
                            });
                            
                            categoryItem.appendChild(subCategoryList);
                        }
                        
                        categoryList.appendChild(categoryItem);
                    }
                });
            }
            
            // 检查是否为当前分类的父分类
            isParentOfCurrentCategory(parentId) {
                if (!this.currentCategory) return false;
                
                const currentCategory = this.categories.find(c => c.id === this.currentCategory);
                return currentCategory && currentCategory.parent === parentId;
            }

            // 渲染分类管理
            renderCategoryManagement() {
                const categoryManagementList = document.getElementById('categoryManagementList');
                categoryManagementList.innerHTML = '';
                
                // 顶级分类
                const topLevelCategories = this.categories.filter(category => !category.parent);
                
                topLevelCategories.forEach(category => {
                    const categoryItem = document.createElement('li');
                    categoryItem.className = 'category-item';
                    categoryItem.innerHTML = `
                        <div class="flex space-between align-center">
                            <span>${category.name}</span>
                            <div>
                                <button class="btn btn-warning edit-category" data-id="${category.id}">编辑</button>
                                <button class="btn btn-danger delete-category" data-id="${category.id}">删除</button>
                            </div>
                        </div>
                    `;
                    
                    // 添加子分类
                    if (category.children && category.children.length > 0) {
                        const subCategoryList = document.createElement('ul');
                        subCategoryList.className = 'sub-category show';
                        
                        category.children.forEach(childId => {
                            const childCategory = this.categories.find(c => c.id === childId);
                            if (childCategory) {
                                const childItem = document.createElement('li');
                                childItem.className = 'category-item';
                                childItem.innerHTML = `
                                    <div class="flex space-between align-center">
                                        <span>${childCategory.name}</span>
                                        <div>
                                            <button class="btn btn-warning edit-category" data-id="${childCategory.id}">编辑</button>
                                            <button class="btn btn-danger delete-category" data-id="${childCategory.id}">删除</button>
                                        </div>
                                    </div>
                                `;
                                subCategoryList.appendChild(childItem);
                            }
                        });
                        
                        categoryItem.appendChild(subCategoryList);
                    }
                    
                    categoryManagementList.appendChild(categoryItem);
                });
                
                // 添加编辑和删除分类的事件
                document.querySelectorAll('.edit-category').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const categoryId = btn.dataset.id;
                        this.editCategory(categoryId);
                    });
                });
                
                document.querySelectorAll('.delete-category').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const categoryId = btn.dataset.id;
                        this.deleteCategory(categoryId);
                    });
                });
                
                // 填充父分类下拉框
                const parentCategorySelect = document.getElementById('parentCategory');
                parentCategorySelect.innerHTML = '<option value="">无（顶级分类）</option>';
                
                topLevelCategories.forEach(category => {
                    // 跳过特殊分类
                    if (category.id === 'learning' || category.id === 'mastered' || category.id === 'all') {
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    parentCategorySelect.appendChild(option);
                });
            }
            
            // 导出词库方法
            exportVocab() {
                // 准备要导出的数据
                const exportData = {
                    words: this.words,
                    categories: this.categories,
                    exportDate: new Date().toISOString(),
                    version: '1.0'
                };
                
                // 转换为JSON字符串
                const jsonString = JSON.stringify(exportData, null, 2);
                
                // 创建下载链接
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // 创建一个临时的a标签并触发下载
                const a = document.createElement('a');
                const date = new Date().toISOString().split('T')[0]; // 获取当前日期作为文件名一部分
                a.href = url;
                a.download = `法语词库_${date}.json`;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
            }
            
            // 导入词库方法
            importVocab() {
                const fileInput = document.getElementById('importFile');
                const mergeExisting = document.getElementById('mergeExisting').checked;
                
                if (!fileInput.files || fileInput.files.length === 0) {
                    alert('请选择要导入的文件');
                    return;
                }
                
                const file = fileInput.files[0];
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        // 解析导入的数据
                        const importedData = JSON.parse(e.target.result);
                        
                        // 验证数据格式
                        if (!importedData.words || !importedData.categories) {
                            throw new Error('导入的文件格式不正确');
                        }
                        
                        if (mergeExisting) {
                            // 合并到现有词库
                            this.mergeImportedData(importedData);
                        } else {
                            // 覆盖现有词库
                            this.words = importedData.words;
                            this.categories = importedData.categories;
                            this.saveData();
                        }
                        
                        // 刷新UI
                        this.renderCategories();
                        this.renderWords();
                        
                        // 关闭模态框
                        this.closeModal('importModal');
                        
                        // 重置文件输入
                        fileInput.value = '';
                        
                        alert('词库导入成功！');
                    } catch (error) {
                        console.error('导入出错:', error);
                        alert(`导入失败: ${error.message}`);
                    }
                };
                
                reader.onerror = () => {
                    alert('读取文件时出错');
                };
                
                reader.readAsText(file);
            }
            
            // 合并导入的数据
            mergeImportedData(importedData) {
                // 合并分类
                this.mergeCategories(importedData.categories);
                
                // 合并单词
                this.mergeWords(importedData.words);
                
                // 保存更新后的数据
                this.saveData();
            }
            
            // 合并分类
            mergeCategories(importedCategories) {
                importedCategories.forEach(importedCategory => {
                    // 检查分类是否已存在
                    const existingCategory = this.categories.find(c => c.id === importedCategory.id);
                    
                    if (!existingCategory) {
                        // 如果分类不存在，添加它
                        this.categories.push(importedCategory);
                    } else {
                        // 如果分类存在，但可能有不同的子分类，合并子分类
                        if (importedCategory.children && importedCategory.children.length > 0) {
                            importedCategory.children.forEach(childId => {
                                if (!existingCategory.children.includes(childId)) {
                                    existingCategory.children.push(childId);
                                }
                            });
                        }
                    }
                });
            }
            
            // 合并单词
            mergeWords(importedWords) {
                importedWords.forEach(importedWord => {
                    // 检查单词是否已存在
                    const existingWordIndex = this.words.findIndex(w => w.word === importedWord.word);
                    
                    if (existingWordIndex === -1) {
                        // 如果单词不存在，检查分类是否存在
                        this.ensureWordCategory(importedWord);
                        
                        // 添加单词
                        this.words.push(importedWord);
                    } else {
                        // 如果单词已存在，可以选择更新它
                        // 这里可以根据需要选择更新策略
                        // 例如，只更新某些字段或询问用户
                        
                        // 这里简单地使用较新的版本
                        const existingWord = this.words[existingWordIndex];
                        const existingDate = new Date(existingWord.lastReviewed);
                        const importedDate = new Date(importedWord.lastReviewed);
                        
                        if (importedDate > existingDate) {
                            // 确保分类存在
                            this.ensureWordCategory(importedWord);
                            
                            // 更新单词
                            this.words[existingWordIndex] = importedWord;
                        }
                    }
                });
            }
            
            // 确保单词分类存在，如果不存在使用最接近的分类
            ensureWordCategory(word) {
                // 如果分类不存在，尝试找到最接近的分类
                if (!this.categories.some(c => c.id === word.category)) {
                    // 检查是否有精确匹配的分类名称
                    const categoryByName = this.categories.find(c => 
                        c.name === word.category || c.id.includes(word.category)
                    );
                    
                    if (categoryByName) {
                        word.category = categoryByName.id;
                    } else {
                        // 使用API自动分类（此处实际可能需要异步处理）
                        // 为简化，这里使用默认分类或根据词汇内容进行本地分类
                        this.performLocalClassificationForImport(word);
                    }
                }
            }
            
            // 为导入的单词执行本地分类
            performLocalClassificationForImport(word) {
                // 分类关键词字典
                const categoryKeywords = {
                    'economy-macro': ['économie', 'pib', 'inflation', 'croissance', '经济', '增长', '通胀', 'marché', '市场'],
                    'economy-finance': ['finance', 'bourse', 'banque', '金融', '银行', 'investissement', '投资'],
                    'economy-micro': ['entreprise', 'prix', 'offre', 'demande', '企业', '价格', '供应', '需求'],
                    'management-hr': ['ressources humaines', 'recrutement', 'employé', '人力资源', '招聘', '员工'],
                    'management-strategy': ['stratégie', 'gestion', 'objectif', '战略', '管理', '目标'],
                    'transportation': ['transport', 'voiture', 'train', 'avion', '交通', '汽车', '火车', '飞机'],
                    'education': ['éducation', 'école', 'université', '教育', '学校', '大学']
                };
                
                // 搜索文本是单词和翻译的组合
                const searchText = (word.word + ' ' + word.translation).toLowerCase();
                
                // 对每个类别计算匹配分数
                const categoryScores = {};
                
                for (const [category, keywords] of Object.entries(categoryKeywords)) {
                    categoryScores[category] = 0;
                    
                    for (const keyword of keywords) {
                        if (searchText.includes(keyword.toLowerCase())) {
                            categoryScores[category] += 1;
                        }
                    }
                }
                
                // 找出得分最高的类别
                let highestScore = 0;
                let suggestedCategory = '';
                
                for (const [category, score] of Object.entries(categoryScores)) {
                    if (score > highestScore) {
                        highestScore = score;
                        suggestedCategory = category;
                    }
                }
                
                // 如果找到了分类，就使用它
                if (suggestedCategory && highestScore > 0) {
                    word.category = suggestedCategory;
                } else {
                    // 如果没有找到匹配的分类，就使用第一个顶级分类
                    const fallbackCategory = this.categories.find(c => !c.parent && 
                        c.id !== 'all' && c.id !== 'learning' && c.id !== 'mastered');
                    
                    if (fallbackCategory) {
                        word.category = fallbackCategory.id;
                    } else {
                        // 实在没有分类就设为空
                        word.category = '';
                    }
                }
            }

            // 清理导入文本
            cleanupImportText() {
                const textArea = document.getElementById('importWordText');
                const statusIndicator = document.getElementById('cleanupStatus');
                
                if (!textArea.value.trim()) {
                    alert('请先输入文本');
                    return;
                }
                
                // 获取当前文本
                const inputText = textArea.value;
                
                // 显示加载状态
                statusIndicator.textContent = "处理中...";
                statusIndicator.style.display = 'inline';
                statusIndicator.style.color = "var(--primary-color)";
                document.getElementById('cleanupTextBtn').disabled = true;
                document.getElementById('cleanupTextBtn').textContent = '处理中...';
                
                // 准备请求数据
                const requestData = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: "你是一个专业的法语文本处理助手。请从用户输入的文本中提取所有法语单词和词组，每行一个词条。如果遇到带词性标注的词条(如v.t.、n.m.、adj.等)，请保留并格式化为'单词 词性'的形式，比如'transformer v.t.'。如果词条后有中文释义，请去除中文释义。你的输出应该是一个干净的法语词汇列表，每行一个词条。"
                        },
                        {
                            role: "user",
                            content: `请处理以下文本，提取所有法语单词和词组，每行返回一个词条：\n\n${inputText}`
                        }
                    ],
                    temperature: 0.3
                };
                
                // 发送请求
                fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('API 请求失败：' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    // 处理返回结果
                    if (data.choices && data.choices.length > 0) {
                        // 获取处理后的文本
                        const processedText = data.choices[0].message.content.trim();
                        
                        // 更新文本区域
                        textArea.value = processedText;
                        
                        // 显示成功状态
                        statusIndicator.textContent = "✓ 已清理";
                        statusIndicator.style.color = "var(--success)";
                    } else {
                        throw new Error('API 返回结果异常');
                    }
                })
                .catch(error => {
                    console.error('处理文本出错:', error);
                    
                    // 显示错误状态
                    statusIndicator.textContent = "✗ 处理失败";
                    statusIndicator.style.color = "var(--danger)";
                    
                    // 使用本地方法处理
                    this.processTextLocally(inputText, textArea);
                })
                .finally(() => {
                    // 恢复按钮状态
                    document.getElementById('cleanupTextBtn').disabled = false;
                    document.getElementById('cleanupTextBtn').textContent = '清理文本';
                    
                    // 3秒后隐藏状态指示器
                    setTimeout(() => {
                        statusIndicator.style.display = 'none';
                    }, 3000);
                });
            }
            
            // 使用API处理文本
            async processTextWithAI(text) {
                // 使用API智能处理文本
                
                // 准备请求数据
                const requestData = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: "你是一个专业的法语文本处理助手。请从用户输入的文本中提取所有法语单词和词组，每行一个词条。如果遇到带词性标注的词条(如v.t.、n.m.、adj.等)，请保留并格式化为'单词 词性'的形式。如果词条后有中文释义，不要保留。你的输出应该是一个干净的法语词汇列表，每行一个词条。"
                        },
                        {
                            role: "user",
                            content: `请处理以下文本，提取所有法语单词和词组，每行返回一个词条：\n\n${text}`
                        }
                    ],
                    temperature: 0.3
                };
                
                // 发送请求
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error('API 请求失败：' + response.status);
                }
                
                const data = await response.json();
                
                // 处理返回结果
                if (data.choices && data.choices.length > 0) {
                    return data.choices[0].message.content.trim();
                } else {
                    throw new Error('API 返回结果异常');
                }
            }
            
            // 本地处理文本的方法
            processTextLocally(text, textArea) {
                // 处理文本的步骤
                
                // 1. 将多个空格替换为单个空格
                text = text.replace(/\s+/g, ' ');
                
                // 2. 按行分割
                const lines = text.split(/[\n\r]+/);
                
                // 3. 提取法语单词和词组
                const frenchWords = [];
                
                lines.forEach(line => {
                    // 跳过空行
                    if (!line.trim()) return;
                    
                    // 处理每一行
                    // 匹配法语单词或词组，可能带有词性标注(如v.t.、n.m.等)
                    const matches = line.match(/([a-záàâäæçéèêëîïôœùûüÿçÀÂÄÆÇÉÈÊËÎÏÔŒÙÛÜŸ'\-]+(?:\s+[a-záàâäæçéèêëîïôœùûüÿçÀÂÄÆÇÉÈÊËÎÏÔŒÙÛÜŸ'\-]+)*(?:\s+[a-z]+\.[a-z]+\.?)?)/gi);
                    
                    if (matches) {
                        // 添加所有匹配项
                        matches.forEach(match => {
                            const word = match.trim();
                            if (word && word.length > 1 && !frenchWords.includes(word)) {
                                frenchWords.push(word);
                            }
                        });
                    }
                });
                
                // 4. 更新文本区域
                textArea.value = frenchWords.join('\n');
            }
            
            // 导入CSV词库方法
            importCsvVocab() {
                // 首先检查importCsv内容区域是否存在
                const importCsvContent = document.getElementById('importCsv');
                if (!importCsvContent) {
                    console.error('未找到CSV导入内容区域，可能是HTML结构有问题');
                    alert('无法找到导入区域，请刷新页面后重试');
                    return;
                }
                
                // 确定当前激活的子选项卡
                let activeTab = null;
                const activeTabElement = importCsvContent.querySelector('.tabs .tab.active');
                
                if (activeTabElement && activeTabElement.dataset.tab) {
                    activeTab = activeTabElement.dataset.tab;
                } else {
                    // 如果没有激活的选项卡，默认为文件导入
                    console.warn('未找到激活的子选项卡，默认使用文件导入');
                    activeTab = 'csvFileImport';
                }
                
                let wordsList = [];
                
                if (activeTab === 'csvFileImport') {
                    // 文件导入方式
                    const fileInput = document.getElementById('importCsvFile');
                    
                    if (!fileInput) {
                        console.error('未找到CSV文件输入元素');
                        alert('导入功能组件未正确加载，请刷新页面后重试');
                        return;
                    }
                    
                    if (!fileInput.files || fileInput.files.length === 0) {
                        alert('请选择要导入的文件');
                        return;
                    }
                    
                    // 显示进度条
                    const progressContainer = document.getElementById('importProgress');
                    const progressBar = document.getElementById('importProgressBar');
                    const statusText = document.getElementById('importStatus');
                    
                    if (!progressContainer || !progressBar || !statusText) {
                        console.error('未找到进度显示元素');
                        alert('导入功能组件未正确加载，请刷新页面后重试');
                        return;
                    }
                    
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '0%';
                    statusText.textContent = '读取文件中...';
                    
                    const file = fileInput.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            // 解析CSV数据
                            const csvData = e.target.result;
                            const lines = csvData.split(/[\n\r]+/).filter(line => line.trim());
                            
                            // 处理每一行，提取单词信息
                            lines.forEach(line => {
                                const parts = line.split(',').map(part => part.trim());
                                if (parts.length >= 1 && parts[0]) {
                                    // 去除引号并获取法语单词
                                    const frenchWord = parts[0].replace(/"/g, '').trim();
                                    
                                    // 获取可能的翻译
                                    const translation = parts.length > 1 ? parts[1].replace(/"/g, '').trim() : '';
                                    
                                    if (frenchWord) {
                                        wordsList.push({
                                            word: frenchWord,
                                            translation: translation
                                        });
                                    }
                                }
                            });
                            
                            // 如果没有提取到单词，提示错误
                            if (wordsList.length === 0) {
                                throw new Error('未从文件中提取到有效的法语单词');
                            }
                            
                            // 开始处理单词列表
                            this.processImportedWords(wordsList);
                        } catch (error) {
                            console.error('解析文件出错:', error);
                            alert(`导入失败: ${error.message}`);
                            
                            // 隐藏进度条
                            if (progressContainer) {
                                progressContainer.style.display = 'none';
                            }
                        }
                    };
                    
                    reader.onerror = () => {
                        alert('读取文件时出错');
                        if (progressContainer) {
                            progressContainer.style.display = 'none';
                        }
                    };
                    
                    reader.readAsText(file);
                } else if (activeTab === 'csvTextImport') {
                    // 文本框导入方式
                    const textArea = document.getElementById('importWordText');
                    
                    if (!textArea) {
                        console.error('未找到文本输入区域');
                        alert('导入功能组件未正确加载，请刷新页面后重试');
                        return;
                    }
                    
                    const text = textArea.value.trim();
                    
                    if (!text) {
                        alert('请输入要导入的单词');
                        return;
                    }
                    
                    // 显示进度指示
                    const progressContainer = document.getElementById('importProgress');
                    const progressBar = document.getElementById('importProgressBar');
                    const statusText = document.getElementById('importStatus');
                    
                    if (!progressContainer || !progressBar || !statusText) {
                        console.error('未找到进度显示元素');
                        alert('导入功能组件未正确加载，请刷新页面后重试');
                        return;
                    }
                    
                    progressContainer.style.display = 'block';
                    progressBar.style.width = '10%';
                    statusText.textContent = '处理文本中...';
                    
                    // 分割并处理每一行
                    const lines = text.split(/[\n\r]+/).filter(line => line.trim());
                    
                    // 处理每个单词或词组
                    lines.forEach(line => {
                        const lineTrim = line.trim();
                        
                        if (!lineTrim) return;
                        
                        // 匹配词性标注的正则表达式 - 支持常见法语词性标注
                        // 如: n.m., n.f., v.t., v.i., adj., adv., prép., conj. 等
                        const wordPartsMatch = lineTrim.match(/^(.+?)(?:\s+([a-z]+\.[a-z]?\.?(?:\s+et\s+[a-z]+\.[a-z]?\.?)?))?$/i);
                        
                        if (wordPartsMatch) {
                            const word = wordPartsMatch[1].trim();
                            const wordClass = wordPartsMatch[2] ? wordPartsMatch[2].trim() : '';
                            
                            // 添加到词汇列表，词性信息可以作为相关词汇保存
                            if (word) {
                                wordsList.push({
                                    word: word,
                                    translation: '',
                                    relatedWords: wordClass // 将词性作为相关词汇保存
                                });
                            }
                        } else if (lineTrim) {
                            // 如果没有识别到词性，直接添加整行
                            wordsList.push({
                                word: lineTrim,
                                translation: ''
                            });
                        }
                    });
                    
                    // 如果没有提取到单词，提示错误
                    if (wordsList.length === 0) {
                        alert('未提取到有效的法语单词');
                        progressContainer.style.display = 'none';
                        return;
                    }
                    
                    // 更新进度
                    progressBar.style.width = '25%';
                    statusText.textContent = `成功识别 ${wordsList.length} 个词条`;
                    
                    // 开始处理单词列表
                    this.processImportedWords(wordsList);
                } else {
                    console.error('未识别的导入选项卡:', activeTab);
                    alert('导入选项未正确设置，请刷新页面后重试');
                }
            }
            
            // 处理导入的单词列表
            async processImportedWords(wordsList) {
                const autoFill = document.getElementById('autoFillCsvWords').checked;
                const autoClassify = document.getElementById('autoClassifyCsvWords').checked;
                
                // 显示进度条
                const progressContainer = document.getElementById('importProgress');
                const progressBar = document.getElementById('importProgressBar');
                const statusText = document.getElementById('importStatus');
                
                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                statusText.textContent = '准备导入...';
                
                // 准备存储导入的单词
                const importedWords = [];
                
                try {
                    // 逐个处理单词
                    for (let i = 0; i < wordsList.length; i++) {
                        const wordData = wordsList[i];
                        
                        // 更新进度
                        const progress = Math.round((i / wordsList.length) * 100);
                        progressBar.style.width = `${progress}%`;
                        statusText.textContent = `正在处理: ${i + 1}/${wordsList.length} - ${wordData.word}`;
                        
                        // 创建新单词对象
                        let newWord = {
                            id: Date.now() + i, // 确保ID唯一
                            word: wordData.word,
                            phonetic: '',
                            translation: wordData.translation || '',
                            example: '',
                            category: '',
                            relatedWords: '',
                            status: 'learning',
                            lastReviewed: new Date().toISOString(),
                            nextReview: new Date(Date.now() + 86400000).toISOString()
                        };
                        
                        // 自动填充单词信息
                        if (autoFill) {
                            try {
                                statusText.textContent = `正在自动填充: ${wordData.word}`;
                                
                                // 调用API获取单词信息
                                const filledWord = await this.fetchWordInfo(wordData.word);
                                
                                if (filledWord) {
                                    // 如果已有翻译则保留，否则使用API返回的翻译
                                    if (!newWord.translation && filledWord.translation) {
                                        newWord.translation = filledWord.translation;
                                    }
                                    
                                    newWord.phonetic = filledWord.phonetic || '';
                                    newWord.example = filledWord.example || '';
                                }
                            } catch (error) {
                                console.error(`自动填充单词 "${wordData.word}" 时出错:`, error);
                                // 继续处理下一个单词
                            }
                        }
                        
                        // 自动分类
                        if (autoClassify && (newWord.translation || newWord.word)) {
                            try {
                                statusText.textContent = `正在分类: ${wordData.word}`;
                                newWord.category = await this.classifyWord(newWord.word, newWord.translation);
                            } catch (error) {
                                console.error(`分类单词 "${wordData.word}" 时出错:`, error);
                                
                                // 使用本地分类作为备用
                                this.performLocalClassificationForImport(newWord);
                            }
                        }
                        
                        // 确保单词的分类存在
                        this.ensureWordCategory(newWord);
                        
                        // 添加到导入列表
                        importedWords.push(newWord);
                        
                        // 给API请求之间添加延迟，避免请求过快被限制
                        if (autoFill || autoClassify) {
                            await new Promise(resolve => setTimeout(resolve, 500));
                        }
                    }
                    
                    // 更新进度
                    progressBar.style.width = '100%';
                    statusText.textContent = '正在添加单词到词库...';
                    
                    // 合并到现有词库
                    this.mergeWords(importedWords);
                    
                    // 保存数据
                    this.saveData();
                    
                    // 刷新UI
                    this.renderCategories();
                    this.renderWords();
                    
                    // 完成
                    statusText.textContent = `成功导入 ${importedWords.length} 个单词!`;
                    
                    // 重置输入
                    if (document.querySelector('#importCsv .tabs .tab.active').dataset.tab === 'fileImport') {
                        document.getElementById('importCsvFile').value = '';
                    } else {
                        document.getElementById('importWordText').value = '';
                    }
                    
                    // 3秒后关闭进度显示
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 3000);
                } catch (error) {
                    console.error('处理导入单词出错:', error);
                    alert(`导入失败: ${error.message}`);
                    
                    // 隐藏进度条
                    progressContainer.style.display = 'none';
                }
            }
            
            // 获取单词信息
            async fetchWordInfo(word) {
                // 准备请求数据
                const requestData = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: "你是一个专业的法语词典助手。请提供输入的法语单词的音标、中文释义和例句。请按照以下JSON格式返回结果：{\"phonetic\": \"音标\", \"translation\": \"中文释义\", \"example\": \"法语例句\"}"
                        },
                        {
                            role: "user",
                            content: `请提供法语单词"${word}"的音标、中文释义和例句`
                        }
                    ],
                    temperature: 0.3
                };
                
                // 发送请求
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error('API 请求失败：' + response.status);
                }
                
                const data = await response.json();
                
                // 处理返回结果
                if (data.choices && data.choices.length > 0) {
                    const content = data.choices[0].message.content;
                    
                    // 尝试提取JSON部分
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        return JSON.parse(jsonMatch[0]);
                    }
                }
                
                return null;
            }
            
            // 使用API分类单词
            async classifyWord(word, translation) {
                // 准备请求数据
                const requestData = {
                    model: "gpt-3.5-turbo",
                    messages: [
                        {
                            role: "system",
                            content: "你是一个专业的法语词汇分类助手。请根据输入的法语单词及其中文含义，将其分类到以下类别之一：economy-macro（宏观经济）, economy-micro（微观经济）, economy-finance（金融市场）, management-hr（人力资源）, management-strategy（战略管理）, transportation（交通）, education（教育）。只需返回分类ID，不要解释。"
                        },
                        {
                            role: "user",
                            content: `法语单词: ${word}, 中文释义: ${translation || '未提供'}`
                        }
                    ],
                    temperature: 0.2
                };
                
                // 发送请求
                const response = await fetch(this.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${this.apiKey}`
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (!response.ok) {
                    throw new Error('API 请求失败：' + response.status);
                }
                
                const data = await response.json();
                
                // 处理返回结果
                if (data.choices && data.choices.length > 0) {
                    const categoryResponse = data.choices[0].message.content.trim();
                    
                    // 检查返回的分类是否在我们的列表中
                    const validCategories = [
                        'economy-macro', 'economy-micro', 'economy-finance',
                        'management-hr', 'management-strategy',
                        'transportation', 'education'
                    ];
                    
                    // 尝试从响应中提取有效分类
                    for (const category of validCategories) {
                        if (categoryResponse.includes(category)) {
                            return category;
                        }
                    }
                }
                
                return '';
            }
        }
        
        // 测验模块
        class QuizModule {
            constructor(app) {
                this.app = app;
                this.currentQuiz = null;
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // 开始测验按钮
                document.getElementById('startQuizBtn').addEventListener('click', () => {
                    this.app.openModal('quizModal');
                    this.setupQuizCategories();
                });
                
                // 开始测验确认按钮
                document.getElementById('startQuizNowBtn').addEventListener('click', () => {
                    this.startQuiz();
                });
                
                // 下一题按钮
                document.getElementById('nextQuestionBtn').addEventListener('click', () => {
                    this.nextQuestion();
                });
                
                // 完成测验按钮
                document.getElementById('finishQuizBtn').addEventListener('click', () => {
                    this.showResults();
                });
                
                // 重新测验按钮
                document.getElementById('restartQuizBtn').addEventListener('click', () => {
                    this.resetQuiz();
                });
            }
            
            setupQuizCategories() {
                const quizCategorySelect = document.getElementById('quizCategory');
                
                // 清除现有选项，保留默认"所有单词"选项
                quizCategorySelect.innerHTML = '<option value="all">所有单词</option>';
                
                // 添加状态选项
                quizCategorySelect.innerHTML += '<option value="learning">正在学习</option>';
                quizCategorySelect.innerHTML += '<option value="mastered">已掌握</option>';
                
                // 添加所有分类
                this.app.categories.forEach(category => {
                    if (!category.parent) { // 只添加顶级分类
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        quizCategorySelect.appendChild(option);
                        
                        // 添加子分类
                        if (category.children && category.children.length > 0) {
                            category.children.forEach(childId => {
                                const childCategory = this.app.categories.find(c => c.id === childId);
                                if (childCategory) {
                                    const childOption = document.createElement('option');
                                    childOption.value = childCategory.id;
                                    childOption.textContent = `-- ${childCategory.name}`;
                                    quizCategorySelect.appendChild(childOption);
                                }
                            });
                        }
                    }
                });
            }
            
            startQuiz() {
                const category = document.getElementById('quizCategory').value;
                const quizType = document.getElementById('quizType').value;
                const quizCount = parseInt(document.getElementById('quizCount').value);
                
                // 筛选出符合条件的单词
                let availableWords = [...this.app.words];
                
                if (category !== 'all') {
                    if (category === 'learning' || category === 'mastered') {
                        availableWords = availableWords.filter(word => word.status === category);
                    } else {
                        availableWords = availableWords.filter(word => word.category === category);
                    }
                }
                
                if (availableWords.length < 4) {
                    alert('此分类下的单词数量不足，无法开始测验');
                    return;
                }
                
                // 随机选择题目
                const quizWords = this.getRandomItems(availableWords, Math.min(quizCount, availableWords.length));
                
                this.currentQuiz = {
                    words: quizWords,
                    type: quizType,
                    currentIndex: 0,
                    score: 0,
                    answers: []
                };
                
                // 隐藏设置页面，显示题目页面
                document.getElementById('quizSetup').style.display = 'none';
                document.getElementById('quizQuestions').style.display = 'block';
                document.getElementById('quizResults').style.display = 'none';
                
                // 显示第一道题目
                this.showQuestion();
            }
            
            showQuestion() {
                const quizWord = this.currentQuiz.words[this.currentQuiz.currentIndex];
                const question = document.getElementById('quizQuestion');
                const optionsContainer = document.getElementById('quizOptions');
                
                // 清空选项
                optionsContainer.innerHTML = '';
                
                // 设置问题
                if (this.currentQuiz.type === 'fr-to-zh') {
                    question.textContent = quizWord.word;
                } else {
                    question.textContent = quizWord.translation;
                }
                
                // 准备选项
                let options = [];
                const correctAnswer = this.currentQuiz.type === 'fr-to-zh' ? quizWord.translation : quizWord.word;
                options.push(correctAnswer);
                
                // 从其他单词中选择3个错误选项
                const otherWords = this.app.words.filter(word => word.id !== quizWord.id);
                const wrongOptions = this.getRandomItems(otherWords, 3).map(word => 
                    this.currentQuiz.type === 'fr-to-zh' ? word.translation : word.word
                );
                options = options.concat(wrongOptions);
                
                // 打乱选项顺序
                options = this.shuffleArray(options);
                
                // 渲染选项
                options.forEach((option, index) => {
                    const optionEl = document.createElement('li');
                    optionEl.className = 'quiz-option';
                    optionEl.textContent = option;
                    optionEl.setAttribute('data-option', index);
                    
                    optionEl.addEventListener('click', () => {
                        this.checkAnswer(option, correctAnswer, optionEl);
                    });
                    
                    optionsContainer.appendChild(optionEl);
                });
                
                // 更新进度条
                const progressPercentage = (this.currentQuiz.currentIndex / this.currentQuiz.words.length) * 100;
                document.getElementById('quizProgressBar').style.width = `${progressPercentage}%`;
                
                // 隐藏下一题按钮
                document.getElementById('nextQuestionBtn').style.display = 'none';
                document.getElementById('finishQuizBtn').style.display = 'none';
            }
            
            checkAnswer(selectedOption, correctAnswer, optionEl) {
                // 禁用所有选项
                document.querySelectorAll('.quiz-option').forEach(option => {
                    option.style.pointerEvents = 'none';
                });
                
                const isCorrect = selectedOption === correctAnswer;
                
                // 显示正确/错误反馈
                if (isCorrect) {
                    optionEl.classList.add('correct');
                    this.currentQuiz.score++;
                } else {
                    optionEl.classList.add('incorrect');
                    // 高亮正确选项
                    document.querySelectorAll('.quiz-option').forEach(option => {
                        if (option.textContent === correctAnswer) {
                            option.classList.add('correct');
                        }
                    });
                }
                
                // 记录答案
                this.currentQuiz.answers.push({
                    word: this.currentQuiz.words[this.currentQuiz.currentIndex],
                    selected: selectedOption,
                    correct: isCorrect
                });
                
                // 判断是否为最后一题
                const isLastQuestion = this.currentQuiz.currentIndex === this.currentQuiz.words.length - 1;
                
                // 显示下一题或完成按钮
                if (isLastQuestion) {
                    document.getElementById('finishQuizBtn').style.display = 'block';
                } else {
                    document.getElementById('nextQuestionBtn').style.display = 'block';
                }
            }
            
            nextQuestion() {
                this.currentQuiz.currentIndex++;
                this.showQuestion();
            }
            
            showResults() {
                // 隐藏题目页面，显示结果页面
                document.getElementById('quizQuestions').style.display = 'none';
                document.getElementById('quizResults').style.display = 'block';
                
                // 更新得分
                document.getElementById('quizScore').textContent = this.currentQuiz.score;
                document.getElementById('quizTotal').textContent = this.currentQuiz.words.length;
                
                // 渲染结果列表
                const resultsList = document.getElementById('quizResultsList');
                resultsList.innerHTML = '';
                
                this.currentQuiz.answers.forEach(answer => {
                    const resultItem = document.createElement('div');
                    resultItem.className = `quiz-result-item ${answer.correct ? 'correct' : 'incorrect'}`;
                    
                    if (this.currentQuiz.type === 'fr-to-zh') {
                        resultItem.innerHTML = `
                            <p>${answer.word.word} - ${answer.word.translation}</p>
                            <p>你的回答: ${answer.selected}</p>
                        `;
                    } else {
                        resultItem.innerHTML = `
                            <p>${answer.word.translation} - ${answer.word.word}</p>
                            <p>你的回答: ${answer.selected}</p>
                        `;
                    }
                    
                    resultsList.appendChild(resultItem);
                });
                
                // 更新单词的复习状态
                this.updateWordReviewStatus();
            }
            
            updateWordReviewStatus() {
                this.currentQuiz.answers.forEach(answer => {
                    const word = this.app.words.find(w => w.id === answer.word.id);
                    if (word) {
                        word.lastReviewed = new Date().toISOString();
                        
                        // 根据答题正确与否设置下次复习时间
                        const nextReviewDate = new Date();
                        if (answer.correct) {
                            // 正确：如果是学习中的词，可能升级为已掌握
                            if (word.status === 'learning') {
                                // 如果连续答对3次，升级为已掌握
                                // 这里简化处理，实际可能需要记录连续答对次数
                                const randomChance = Math.random();
                                if (randomChance > 0.7) {
                                    word.status = 'mastered';
                                }
                            }
                            // 已掌握的词或未升级的词，下次复习时间延后
                            nextReviewDate.setDate(nextReviewDate.getDate() + 3); // 3天后
                        } else {
                            // 错误：需要更频繁复习
                            nextReviewDate.setDate(nextReviewDate.getDate() + 1); // 1天后
                            
                            // 如果是已掌握的词答错了，可能降级为学习中
                            if (word.status === 'mastered') {
                                const randomChance = Math.random();
                                if (randomChance > 0.5) {
                                    word.status = 'learning';
                                }
                            }
                        }
                        
                        word.nextReview = nextReviewDate.toISOString();
                    }
                });
                
                // 保存更新
                this.app.saveData();
            }
            
            resetQuiz() {
                // 返回到测验设置页面
                document.getElementById('quizSetup').style.display = 'block';
                document.getElementById('quizQuestions').style.display = 'none';
                document.getElementById('quizResults').style.display = 'none';
                
                // 重置测验数据
                this.currentQuiz = null;
            }
            
            // 工具函数：获取随机项目
            getRandomItems(array, count) {
                const shuffled = [...array].sort(() => 0.5 - Math.random());
                return shuffled.slice(0, count);
            }
            
            // 工具函数：打乱数组
            shuffleArray(array) {
                return [...array].sort(() => 0.5 - Math.random());
            }
        }
        
        // 初始化应用
        const app = new VocabApp();
        
        // 添加模态框关闭事件
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                const modal = this.closest('.modal');
                modal.style.display = 'none';
            });
        });
        
        // 点击模态框外部关闭
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });
    });
    </script>
</body>
</html>